name: Weekly Taekwondo Rankings Sync

on:
  schedule:
    # Run every Sunday at 2:00 AM UTC
    - cron: '0 2 * * 0'

  workflow_dispatch:
    inputs:
      full_refresh:
        description: 'Force full data refresh'
        required: false
        default: 'false'
        type: boolean
      check_only:
        description: 'Check for changes only (no upload)'
        required: false
        default: 'false'
        type: boolean

jobs:
  sync-rankings:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    outputs:
      success: ${{ steps.sync.outputs.success }}
      has_changes: ${{ steps.sync.outputs.has_changes }}
      records: ${{ steps.sync.outputs.records }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # Ensure Azure and scraping dependencies
          pip install azure-storage-blob azure-identity duckdb pyarrow selenium webdriver-manager

      - name: Set up Chrome for scraping
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: Run rankings sync
        id: sync
        env:
          AZURE_STORAGE_CONNECTION_STRING: ${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}
          PYTHONUNBUFFERED: '1'
        run: |
          if [ "${{ inputs.check_only }}" == "true" ]; then
            python sync_rankings.py --check-only
          else
            python sync_rankings.py
          fi

      - name: Upload sync artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sync-results-${{ github.run_id }}
          path: |
            ranking_changes.json
            alert_message.txt
            data_incremental/rankings/*.csv
          retention-days: 30

      - name: Check for alert message
        id: check_alert
        run: |
          if [ -f "alert_message.txt" ] && [ -s "alert_message.txt" ]; then
            echo "has_alert=true" >> $GITHUB_OUTPUT
          else
            echo "has_alert=false" >> $GITHUB_OUTPUT
          fi

    # Trigger alert workflow if changes detected
  trigger-alerts:
    needs: sync-rankings
    if: needs.sync-rankings.outputs.has_changes == 'true'
    uses: ./.github/workflows/send-alerts.yml
    secrets: inherit

  # Summary job
  summary:
    needs: [sync-rankings]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Sync Summary
        run: |
          echo "## Taekwondo Rankings Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Success | ${{ needs.sync-rankings.outputs.success }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Records Synced | ${{ needs.sync-rankings.outputs.records }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Has Changes | ${{ needs.sync-rankings.outputs.has_changes }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Run Time | $(date -u) |" >> $GITHUB_STEP_SUMMARY
